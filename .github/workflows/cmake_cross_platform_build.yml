name: CMake Cross-Platform Build

on: [push, pull_request]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            triplet: x64-linux
            generator: "Unix Makefiles"
          - os: windows-latest
            triplet: x64-windows
            generator: "Visual Studio 17 2022"
          - os: macos-latest
            triplet: x64-osx
            generator: "Unix Makefiles"

    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        repository: grodansparadis/vscpl2drv-websocksrv
        submodules: 'recursive' 

    - name: Checkout VSCP repository
      uses: actions/checkout@v4
      with:
        repository: grodansparadis/vscp
        path: vscp
        ref: development

    # Setup vcpkg for Windows
    - name: Setup vcpkg (Windows)
      if: runner.os == 'Windows'
      uses: microsoft/setup-msbuild@v1.1

    - name: Install vcpkg dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        .\bootstrap-vcpkg.bat
        .\vcpkg.exe install expat:x64-windows openssl:x64-windows
        echo "VCPKG_ROOT=${{ github.workspace }}\vcpkg" >> $env:GITHUB_ENV
        echo "CMAKE_TOOLCHAIN_FILE=${{ github.workspace }}\vcpkg\scripts\buildsystems\vcpkg.cmake" >> $env:GITHUB_ENV

    # Linux dependencies
    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y  libexpat1-dev libssl-dev pandoc

    # macOS dependencies
    - name: Install macOS dependencies
      if: runner.os == 'macOS'
      run: |
        brew update
        brew install openssl expat pandoc pkg-config
        echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl)" >> $GITHUB_ENV
        echo "EXPAT_ROOT_DIR=$(brew --prefix expat)" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=$(brew --prefix openssl)/lib/pkgconfig:$(brew --prefix expat)/lib/pkgconfig" >> $GITHUB_ENV

    # Windows dependencies (non-vcpkg)
    - name: Setup Windows dependencies
      if: runner.os == 'Windows'
      run: |
        choco install pandoc libssl-dev

    - name: Create Build Environment
      run: cmake -E make_directory ${{github.workspace}}/build

    # Configure CMake for Linux
    - name: Configure CMake (Linux)
      if: runner.os == 'Linux'
      shell: bash
      working-directory: ${{github.workspace}}/build
      run: |
        cmake $GITHUB_WORKSPACE \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DVSCP_PATH=vscp/ \
          -G "${{ matrix.generator }}"

    # Configure CMake for macOS
    - name: Configure CMake (macOS)
      if: runner.os == 'macOS'
      shell: bash
      working-directory: ${{github.workspace}}/build
      run: |
        cmake $GITHUB_WORKSPACE \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCMAKE_INSTALL_PREFIX=/usr/local \
          -DVSCP_PATH=vscp/ \
          -DOPENSSL_ROOT_DIR="$OPENSSL_ROOT_DIR" \
          -DEXPAT_ROOT_DIR="$EXPAT_ROOT_DIR" \
          -DPKG_CONFIG_USE_CMAKE_PREFIX_PATH=ON \
          -DPkgConfig_EXECUTABLE="$(brew --prefix)/bin/pkg-config" \
          -G "${{ matrix.generator }}"

    # Configure CMake for Windows
    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      working-directory: ${{github.workspace}}/build
      run: |
        cmake %GITHUB_WORKSPACE% ^
          -DCMAKE_BUILD_TYPE=%BUILD_TYPE% ^
          -DVSCP_PATH=vscp/ ^
          -DCMAKE_TOOLCHAIN_FILE=%CMAKE_TOOLCHAIN_FILE% ^
          -DVCPKG_TARGET_TRIPLET=x64-windows ^
          -G "${{ matrix.generator }}" ^
          -A x64

    - name: Build
      working-directory: ${{github.workspace}}/build
      shell: bash
      run: cmake --build . --config $BUILD_TYPE --parallel

    - name: Test
      working-directory: ${{github.workspace}}/build
      shell: bash
      run: ctest -C $BUILD_TYPE --output-on-failure

    # Package for Linux
    - name: Package (Linux)
      if: runner.os == 'Linux'
      working-directory: ${{github.workspace}}/build
      shell: bash
      run: |
        sudo cpack .
        ls -la *.deb *.rpm *.tar.gz || true

    # Package for macOS
    - name: Package (macOS)
      if: runner.os == 'macOS'
      working-directory: ${{github.workspace}}/build
      shell: bash
      run: |
        cpack .
        ls -la *.dmg *.tar.gz || true

    # Package for Windows
    - name: Package (Windows)
      if: runner.os == 'Windows'
      working-directory: ${{github.workspace}}/build
      shell: cmd
      run: |
        cpack .
        dir *.exe *.msi *.zip

    # Upload artifacts
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ matrix.os }}
        path: |
          ${{github.workspace}}/build/*.deb
          ${{github.workspace}}/build/*.rpm
          ${{github.workspace}}/build/*.tar.gz
          ${{github.workspace}}/build/*.dmg
          ${{github.workspace}}/build/*.exe
          ${{github.workspace}}/build/*.msi
          ${{github.workspace}}/build/*.zip
        retention-days: 30

  # Release job (only on tags)
  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}