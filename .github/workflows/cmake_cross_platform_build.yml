name: CMake Cross-Platform Build

on: [push, pull_request]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        # Add macos-latest when ready to test on macOS
        # os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            triplet: x64-linux
            generator: "Unix Makefiles"
            package_manager: "apt"
          - os: windows-latest
            triplet: x64-windows
            generator: "Visual Studio 17 2022"
            package_manager: "vcpkg"
          # Uncomment when ready for macOS
          # - os: macos-latest
          #   triplet: x64-osx
          #   generator: "Unix Makefiles"
          #   package_manager: "brew"

    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        repository: grodansparadis/vscpl2drv-websocksrv
        submodules: 'recursive' 

    - name: Checkout VSCP repository
      uses: actions/checkout@v4
      with:
        repository: grodansparadis/vscp
        path: vscp
        ref: development

    # Setup Visual Studio environment properly for Windows
    - name: Setup MSBuild and Visual Studio (Windows)
      if: runner.os == 'Windows'
      uses: microsoft/setup-msbuild@v1.3
      with:
        msbuild-architecture: x64

    # Add Visual Studio Developer Command Prompt to PATH
    - name: Setup Visual Studio Environment (Windows)
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    # Windows dependencies via vcpkg
    - name: Install vcpkg dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        .\bootstrap-vcpkg.bat
        .\vcpkg.exe install expat:x64-windows openssl:x64-windows pthreads:x64-windows dlfcn-win32:x64-windows
        $vcpkgRoot = "${{ github.workspace }}\vcpkg"
        $toolchainFile = "$vcpkgRoot\scripts\buildsystems\vcpkg.cmake"
        echo "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
        echo "CMAKE_TOOLCHAIN_FILE=$toolchainFile" >> $env:GITHUB_ENV
        Write-Host "Set VCPKG_ROOT to: $vcpkgRoot"
        Write-Host "Set CMAKE_TOOLCHAIN_FILE to: $toolchainFile"

    - name: Setup Windows dependencies
      if: runner.os == 'Windows'
      run: |
        # Install NSIS for creating Windows installers
        choco install nsis pandoc
        
        # Verify NSIS installation
        Write-Host "NSIS installation:"
        where makensis
        makensis /VERSION

    # Create Windows byteswap compatibility header
    - name: Create byteswap compatibility (Windows)
      if: runner.os == 'Windows'
      working-directory: ${{github.workspace}}
      run: |
        @"
        #ifndef BYTESWAP_H
        #define BYTESWAP_H
        #ifdef _WIN32
        #include <intrin.h>
        #include <cstdint>
        static inline uint16_t bswap_16(uint16_t x) { return _byteswap_ushort(x); }
        static inline uint32_t bswap_32(uint32_t x) { return _byteswap_ulong(x); }
        static inline uint64_t bswap_64(uint64_t x) { return _byteswap_uint64(x); }
        #endif
        #endif
        "@ | Out-File -FilePath "byteswap.h" -Encoding UTF8

    # Linux dependencies
    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libexpat1-dev libssl-dev pandoc

    # macOS dependencies (uncomment when ready)
    # - name: Install macOS dependencies
    #   if: runner.os == 'macOS'
    #   run: |
    #     brew update
    #     brew install openssl expat pandoc pkg-config
    #     echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl)" >> $GITHUB_ENV
    #     echo "EXPAT_ROOT_DIR=$(brew --prefix expat)" >> $GITHUB_ENV
    #     echo "CMAKE_PREFIX_PATH=$(brew --prefix openssl):$(brew --prefix expat):$(brew --prefix)" >> $GITHUB_ENV
    #     echo "PKG_CONFIG_PATH=$(brew --prefix openssl)/lib/pkgconfig:$(brew --prefix expat)/lib/pkgconfig:$(brew --prefix)/lib/pkgconfig" >> $GITHUB_ENV
    #     echo "EXPAT_INCLUDE_DIR=$(brew --prefix expat)/include" >> $GITHUB_ENV
    #     echo "EXPAT_LIBRARY=$(brew --prefix expat)/lib/libexpat.dylib" >> $GITHUB_ENV

    - name: Create Build Environment
      run: cmake -E make_directory ${{github.workspace}}/build

    # Test Visual Studio compiler (Windows)
    - name: Test Visual Studio Compiler (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        Write-Host "Testing Visual Studio environment..."
        where cl.exe
        cl.exe 2>&1 | Write-Host
        Write-Host "Visual Studio variables:"
        Get-ChildItem env: | Where-Object {$_.Name -match "VS|MSVC|VC"} | Format-Table Name, Value -AutoSize

    # Configure CMake for Linux
    - name: Configure CMake (Linux)
      if: runner.os == 'Linux'
      shell: bash
      working-directory: ${{github.workspace}}/build
      run: |
        cmake $GITHUB_WORKSPACE \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DVSCP_PATH=vscp/ \
          -G "${{ matrix.generator }}"

    # Configure CMake for Windows (using PowerShell for better variable handling)
    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      working-directory: ${{github.workspace}}/build
      run: |
        Write-Host "VCPKG_ROOT: $env:VCPKG_ROOT"
        Write-Host "CMAKE_TOOLCHAIN_FILE: $env:CMAKE_TOOLCHAIN_FILE"
        
        cmake $env:GITHUB_WORKSPACE `
          -DCMAKE_BUILD_TYPE="$env:BUILD_TYPE" `
          "-DCMAKE_TOOLCHAIN_FILE=$env:CMAKE_TOOLCHAIN_FILE" `
          -DVCPKG_TARGET_TRIPLET=x64-windows `
          -DVSCP_PATH=vscp/ `
          "-DCMAKE_CXX_FLAGS=/utf-8" `
          "-DCMAKE_C_FLAGS=/utf-8" `
          -G "${{ matrix.generator }}" `
          -A x64

    # Configure CMake for macOS (uncomment when ready)
    # - name: Configure CMake (macOS)
    #   if: runner.os == 'macOS'
    #   shell: bash
    #   working-directory: ${{github.workspace}}/build
    #   run: |
    #     cmake $GITHUB_WORKSPACE \
    #       -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
    #       -DCMAKE_INSTALL_PREFIX=/usr/local \
    #       -DVSCP_PATH=vscp/ \
    #       -DOPENSSL_ROOT_DIR="$OPENSSL_ROOT_DIR" \
    #       -DEXPAT_ROOT_DIR="$EXPAT_ROOT_DIR" \
    #       -DEXPAT_INCLUDE_DIR="$EXPAT_INCLUDE_DIR" \
    #       -DEXPAT_LIBRARY="$EXPAT_LIBRARY" \
    #       -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" \
    #       -DPKG_CONFIG_USE_CMAKE_PREFIX_PATH=ON \
    #       -DPkgConfig_EXECUTABLE="$(brew --prefix)/bin/pkg-config" \
    #       -G "${{ matrix.generator }}"

    # Debug: Show CMake configuration for troubleshooting (Linux)
    - name: Debug CMake configuration (Linux)
      if: failure() && runner.os == 'Linux'
      working-directory: ${{github.workspace}}/build
      shell: bash
      run: |
        echo "=== System Information ==="
        echo "OS: ${{ runner.os }}"
        echo "Matrix OS: ${{ matrix.os }}"
        echo "Generator: ${{ matrix.generator }}"
        echo "=== CMake Cache ==="
        cat CMakeCache.txt || echo "No CMakeCache.txt found"
        echo "=== CMake Error Log ==="
        cat CMakeFiles/CMakeError.log || echo "No CMakeError.log found"
        echo "=== CMake Output Log ==="
        cat CMakeFiles/CMakeOutput.log || echo "No CMakeOutput.log found"
        echo "=== Environment Variables ==="
        env | grep -E "(CMAKE|VCPKG|OPENSSL|EXPAT|PKG_CONFIG|VS|MSVC)" || echo "No relevant env vars"
        echo "=== Directory Contents ==="
        ls -la . || dir .
        echo "=== VSCP Directory ==="
        ls -la ../vscp || echo "VSCP directory not found"
        echo "=== CMakeFiles Directory ==="
        ls -la CMakeFiles/ || echo "No CMakeFiles directory"

    # Debug: Show CMake configuration for troubleshooting (Windows)
    - name: Debug CMake configuration (Windows)
      if: failure() && runner.os == 'Windows'
      working-directory: ${{github.workspace}}/build
      shell: powershell
      run: |
        Write-Host "=== System Information ==="
        Write-Host "OS: ${{ runner.os }}"
        Write-Host "Matrix OS: ${{ matrix.os }}"
        Write-Host "Generator: ${{ matrix.generator }}"
        Write-Host "=== CMake Cache ==="
        if (Test-Path "CMakeCache.txt") { Get-Content "CMakeCache.txt" } else { Write-Host "No CMakeCache.txt found" }
        Write-Host "=== CMake Error Log ==="
        if (Test-Path "CMakeFiles/CMakeError.log") { Get-Content "CMakeFiles/CMakeError.log" } else { Write-Host "No CMakeError.log found" }
        Write-Host "=== CMake Output Log ==="
        if (Test-Path "CMakeFiles/CMakeOutput.log") { Get-Content "CMakeFiles/CMakeOutput.log" } else { Write-Host "No CMakeOutput.log found" }
        Write-Host "=== Environment Variables ==="
        Get-ChildItem env: | Where-Object {$_.Name -match "(CMAKE|VCPKG|OPENSSL|EXPAT|PKG_CONFIG|VS|MSVC)"} | Format-Table Name, Value -AutoSize
        Write-Host "=== Directory Contents ==="
        Get-ChildItem -Force
        Write-Host "=== VSCP Directory ==="
        if (Test-Path "../vscp") { Get-ChildItem "../vscp" } else { Write-Host "VSCP directory not found" }
        Write-Host "=== CMakeFiles Directory ==="
        if (Test-Path "CMakeFiles") { Get-ChildItem "CMakeFiles" } else { Write-Host "No CMakeFiles directory" }

    # Build (Linux)
    - name: Build (Linux)
      if: runner.os == 'Linux'
      working-directory: ${{github.workspace}}/build
      shell: bash
      run: cmake --build . --config $BUILD_TYPE --parallel

    # Build (Windows)
    - name: Build (Windows)
      if: runner.os == 'Windows'
      working-directory: ${{github.workspace}}/build
      shell: powershell
      run: cmake --build . --config $env:BUILD_TYPE --parallel

    # Test (Linux)
    - name: Test (Linux)
      if: runner.os == 'Linux'
      working-directory: ${{github.workspace}}/build
      shell: bash
      run: ctest -C $BUILD_TYPE --output-on-failure || echo "No tests defined"

    # Test (Windows)
    - name: Test (Windows)
      if: runner.os == 'Windows'
      working-directory: ${{github.workspace}}/build
      shell: powershell
      run: ctest -C $env:BUILD_TYPE --output-on-failure; if ($LASTEXITCODE -ne 0) { Write-Host "No tests defined or tests failed" }

    # Package for Linux
    - name: Package (Linux)
      if: runner.os == 'Linux'
      working-directory: ${{github.workspace}}/build
      shell: bash
      run: |
        # Try to create packages, but don't fail if some generators aren't available
        cpack -G TGZ . || echo "TGZ package creation failed or not configured"
        cpack -G DEB . || echo "DEB package creation failed or not configured"
        cpack -G RPM . || echo "RPM package creation failed or not configured"
        ls -la *.deb *.rpm *.tar.gz *.tgz 2>/dev/null || echo "No packages generated"

    # Package for Windows
    - name: Package (Windows)
      if: runner.os == 'Windows'
      working-directory: ${{github.workspace}}/build
      shell: powershell
      run: |
        # Try different package generators for Windows
        try { cpack -G ZIP . } catch { Write-Host "ZIP package creation failed or not configured" }
        try { cpack -G NSIS . } catch { Write-Host "NSIS package creation failed or not configured" }
        try { cpack -G WIX . } catch { Write-Host "WIX package creation failed or not configured" }
        Get-ChildItem -Filter "*.exe", "*.msi", "*.zip" -ErrorAction SilentlyContinue | Format-Table Name, Length -AutoSize
        if (-not (Get-ChildItem -Filter "*.exe", "*.msi", "*.zip" -ErrorAction SilentlyContinue)) { Write-Host "No packages generated" }

    # Package for macOS (uncomment when ready)
    # - name: Package (macOS)
    #   if: runner.os == 'macOS'
    #   working-directory: ${{github.workspace}}/build
    #   shell: bash
    #   run: |
    #     cpack -G TGZ . || echo "TGZ package creation failed or not configured"
    #     cpack -G DragNDrop . || echo "DragNDrop package creation failed or not configured"
    #     ls -la *.dmg *.tar.gz *.tgz 2>/dev/null || echo "No packages generated"

    # Upload artifacts
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ matrix.os }}-${{ github.sha }}
        path: |
          ${{github.workspace}}/build/*.deb
          ${{github.workspace}}/build/*.rpm
          ${{github.workspace}}/build/*.tar.gz
          ${{github.workspace}}/build/*.tgz
          ${{github.workspace}}/build/*.dmg
          ${{github.workspace}}/build/*.exe
          ${{github.workspace}}/build/*.msi
          ${{github.workspace}}/build/*.zip
        retention-days: 30

  # Release job (only on tags)
  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}